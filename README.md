# Лабораторная работа
# Тема: "Оптимизация алгоритма расчета множества Мандельброта с помощью SIMD" 
<br>

### Александров Олег
### Б05-331 
### 29.03.2024 

<br>

# Цель работы 
Исследовать влияние оптимизаций компилятора и SIMD инструкций на время работы программы.

# Содержание
1. [Титульный лист](#лабораторная-работа)
2. [Реализация](#реализация)
    1. [Теоретическая справка](#теоретическая-справка)
    2. [Запуск программы](#запуск-программы)
        1. [Зависимости](#зависимости)
    3. [Реализованные режимы](#реализованные-режимы)
        1. [Тестовой режим](#тестовой-режим)
        2. [Графический режим](#графический-режим)
    4. [Реализованные алгоритмы](#реализованные-алгоритмы)
3. [Измерение времени](#измерение-врмени)
    1. [Методика измерений](#методика-измерений)
    2. [Оборудование](#оборудование)
    3. [Результаты](#результаты)
4. [Вывод](#вывод)
5. [Благодарности](#благодарности)
6. [Библиографический список](#библиографический-список)
7. [Приложение](#приложение)

# Реализация

## Теоретическая справка

![Множество Мандельброта](/images/mandelbrot_set.png)

Рассмотрим действительную плоскость и точку из области построения на ней. Координаты точки будем обозначать как $x_0$ и $y_0$. Для каждой точки рассмотрим последовательность, каждый следующий элемент которой будет вычисляться по формуле:

$$y_{n+1} = 2 x_n y_n + x_0$$

$$x_{n+1} = x_n^2 - y_n^2 + y_0$$

Вычисления будут проводиться, пока $n < 256$ и $x_n^2 + y_n^2 \leq 100$. \

Цвет пикселя изображения зависит от $n$. Библиотека [SFML](https://www.sfml-dev.org/) задаёт цвет пикселя в формате `rgba`. Далее цвет рассчитывается по формуле: Если $n = 256$, то цвет - черный, иначе : 

|        R        |        G       |         B        |   A   |
|:---------------:|:--------------:|:----------------:|:-----:|
| $255 * sin(n)$  | $255 * cos(n)$ | $255 * sin(2 n)$ | $255$ |

## Запуск программы

Запуск быстрой реализации подсчета [множества Мандельброта](https://ru.wikipedia.org/wiki/%D0%9C%D0%BD%D0%BE%D0%B6%D0%B5%D1%81%D1%82%D0%B2%D0%BE_%D0%9C%D0%B0%D0%BD%D0%B4%D0%B5%D0%BB%D1%8C%D0%B1%D1%80%D0%BE%D1%82%D0%B0):
```
git clone git@github.com:Ch1n-ch1nless/MandelbrotSet.git
cd MandelbrotSet
make OPT_LEVEL=-O3
./mandelbrot_set -g -i avx
```

Данный код запускает программу в графическом режиме и с реализацией алгоритма, использующий [SIMD]() инструкции. \
Про другие режимы и инструкции в разделах:
[Реализованные режимы](#реализованные-режимы) и [Реализованные алгоритмы](#реализованные-алгоритмы)

Теперь подробнее про команды:
В makefile надо указать значение переменной OPT_LEVEL, в которой хранится уровень оптимизации программы(-O0, -O3, ...)
```
make OPT_LEVEL=<уровень оптимизации>
```

### Зависимости

Для графики была использована библиотека: [SFML](https://www.sfml-dev.org/) <br>
Для машинно зависимых инструкций была использована библиотека: `immintrin.h` <br>
Другие стандартные библиотеки <br>

## Реализованные режимы

Гайд по запуску программы:
Флаги:
```
-h  -- показать гайд, как правильно запустить программу.
-t  -- запустить программу в тестовом режиме.
-g  -- запустить программу в графическом режиме.
```
Так же необходимо указать реализацию функции подсчета множества Мандельброта.
```
-i simple   -- алгоритм будет считать, каждый пиксель на экране отдельно
-i vector   -- алгоритм считает по 8 пикселей за раз без использования SIMD инструкций
-i avx      -- алгоритм считает по 8 пикселей за заз с использованием SIMD инструкций
```

Примеры запуска:
```
./mandelbrot_set -g -i vector   # запустить программу в графическом режиме и векторной реализации
./mandelbrot_set -i simple -t   # запустить программу в тестовом режиме и попиксельной реализации

### Тестовой режим

kjk

### Графический режим

<kbd>←</kbd> -- Переместить камеру влево    \
<kbd>↑</kbd> -- Переместить камеру вверх    \
<kbd>→</kbd> -- Переместить камеру вправо   \
<kbd>↓</kbd> -- Переместить камеру вниз     \
\
<kbd>+</kbd> -- Приблизить камеру   \
<kbd>-</kbd> -- Отдалить камеру     \
\
<kbd>Esc</kbd> -- Выйти из программы 

## Реализованные режимы

kjk

# Измерение времени

kjk

## Методика измерений

kjk

## Оборудование

<b>Компилятор</b>: g++ (Ubuntu 11.4.0-1ubuntu1~22.04) 11.4.0 \
<b>Уровни оптимизаций</b>: -O0, -O1, -O2, -O3 \
[Список всех флагов](#полный-список-всех-флагов) \
<b>Процессор</b> : AMD Ryzen 7 5800H, поддерживающий инструкции: AVX(1, 2) \
<b>ОС</b> : Linux Ubuntu 22.04.4 LTS (64-bit). Все тесты были проведены в режиме "Perfomance".\

## Результаты

kjk

# Вывод

kjk

# Благодарности

kjk

# Библиографический список

kjk

# Приложение

#### Полный список всех флагов

``` 
-Wshadow -Winit-self -Wredundant-decls -Wcast-align -Wundef -Wfloat-equal\
-Winline -Wunreachable-code -Wmissing-declarations -Wmissing-include-dirs \
-Wswitch-enum -Wswitch-default -Weffc++ -Wmain -Wextra -Wall -g -pipe -fexceptions\
-Wcast-qual -Wconversion -Wctor-dtor-privacy -Wempty-body -Wformat-security\
-Wformat=2 -Wignored-qualifiers -Wlogical-op -Wno-missing-field-initializers -Wnon-virtual-dtor\
-Woverloaded-virtual -Wpointer-arith -Wsign-promo -Wstack-usage=8192 -Wstrict-aliasing\
-Wstrict-null-sentinel -Wtype-limits -Wwrite-strings -Werror=vla\
-D_DEBUG -mavx2 -mfma -mavx -msse4.2
```

<h4>Таблица #1</h4>

|    1   |       -O0     |       -O1     |       -O2     |       -O3     |
|:------:|:-------------:|:-------------:|:-------------:|:-------------:|
| SIMPLE | 1283439571.84 |  448444564.8  |  410016640.32 |  422716402.56 |
| VECTOR | 3072940250.24 |  639090985.6  |  588554806.4  |  211630263.68 |
| AVX    |  434582454.4  |   60887493.12 |   60983936.32 |   60072843.84 |

<h4>Таблица #2</h4>

|    2   |       -O0     |       -O1     |       -O2     |       -O3     |
|:------:|:-------------:|:-------------:|:-------------:|:-------------:|
| SIMPLE | 1257265602.56 |  444082539.2  |  408647919.04 |  411939588.8  |
| VECTOR | 3266982525.76 |  669882133.12 |  655140738.88 |  228828652.8  |
| AVX    |  460258106.88 |   62694989.76 |   62216597.76 |   62121263.04 |

<h4>Таблица #3</h4>

|    3   |       -O0     |       -O1     |       -O2     |       -O3     |
|:------:|:-------------:|:-------------:|:-------------:|:-------------:|
| SIMPLE | 1206867259.2  |  443740706.88 |  407006695.68 |  407068553.6  |
| VECTOR | 3158986114.24 |  647464094.4  |  635349811.84 |  222189628.16 |
| AVX    |  449727304.0  |   63756742.4  |   64575378.56 |   61044048.64 |

<h4>Таблица #4</h4>

|    4   |       -O0     |       -O1     |       -O2     |       -O3     |
|:------:|:-------------:|:-------------:|:-------------:|:-------------:|
| SIMPLE | 1206456320.96 |  443143494.08 |  407327719.04 |  407013029.44 |
| VECTOR | 3161458192.96 |  653433014.08 |  618613750.72 |  217610872.64 |
| AVX    |  438641075.52 |   63356642.56 |   63660352.32 |   60953052.16 |

<h4>Таблица #5</h4>

|    5   |       -O0     |       -O1     |       -O2     |       -O3     |
|:------:|:-------------:|:-------------:|:-------------:|:-------------:|
| SIMPLE | 1206640666.56 |  442867832.96 |  406931645.76 |  407244093.44 |
| VECTOR | 3103675312.96 |  654002534.08 |  614539704.64 |  219158337.92 |
| AVX    |  440524551.36 |   63067849.6  |   62766071.68 |   62159874.24 |

<h4>Финальная таблица</h4>

Данные в таблице имеют размерность такт * $10^6$

| FINAL  |        -O0        |         -O1       |         -O2       |         -O3       |
|:------:|:-----------------:|:-----------------:|:-----------------:|:-----------------:|
| SIMPLE |$1232.13 \pm 32.28$| $444.46 \pm 2.04$ | $407.99 \pm 1.19$ | $411.20 \pm 6.06$ |
| VECTOR |$3152.78 \pm 66.24$| $652.77 \pm 10.10$| $622.43 \pm 22.19$| $219.88 \pm 5.64$ |
| AVX    | $444.74 \pm 9.20$ | $ 62.75 \pm 1$    | $ 62.84 \pm 1.23$ | $61.27  \pm 0.79$ |